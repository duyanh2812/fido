# Custom WSO2 IS Dockerfile with localhost data and proper permission fixes
FROM --platform=$BUILDPLATFORM wso2/wso2is:7.1.0

# Set working directory
WORKDIR /home/wso2carbon/wso2is-7.1.0

# Copy entire WSO2 IS localhost data
COPY wso2-data/repository/database /home/wso2carbon/wso2is-7.1.0/repository/database
COPY wso2-data/repository/conf /home/wso2carbon/wso2is-7.1.0/repository/conf
COPY wso2-data/repository/logs /home/wso2carbon/wso2is-7.1.0/repository/logs
COPY wso2-data/repository/deployment /home/wso2carbon/wso2is-7.1.0/repository/deployment
COPY wso2-data/repository/tenants /home/wso2carbon/wso2is-7.1.0/repository/tenants
COPY wso2-data/repository/components /home/wso2carbon/wso2is-7.1.0/repository/components
COPY wso2-data/repository/data /home/wso2carbon/wso2is-7.1.0/repository/data
COPY wso2-data/repository/resources /home/wso2carbon/wso2is-7.1.0/repository/resources

# Fix permissions properly using root user
USER root
RUN groupadd -r wso2carbon 2>/dev/null || true && \
    useradd -r -g wso2carbon wso2carbon 2>/dev/null || true && \
    chown -R wso2carbon:wso2carbon /home/wso2carbon/wso2is-7.1.0 && \
    chmod -R 755 /home/wso2carbon/wso2is-7.1.0/repository && \
    chmod -R 777 /home/wso2carbon/wso2is-7.1.0/repository/logs && \
    chmod -R 777 /home/wso2carbon/wso2is-7.1.0/repository/components/dropins && \
    chmod -R 777 /home/wso2carbon/wso2is-7.1.0/repository/components/patches && \
    chmod -R 777 /home/wso2carbon/wso2is-7.1.0/repository/components/default && \
    chmod -R 777 /home/wso2carbon/wso2is-7.1.0/repository/components/default/configuration && \
    echo "Permissions fixed successfully"

# Switch back to wso2carbon user
USER wso2carbon

# Expose ports
EXPOSE 9443 9763

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
  CMD curl -f https://localhost:9443/carbon/admin/login.jsp -k || exit 1

# Use the original entrypoint
ENTRYPOINT ["/home/wso2carbon/docker-entrypoint.sh"]
